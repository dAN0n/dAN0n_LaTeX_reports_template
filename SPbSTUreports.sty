\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{SPbSTUreports}[02/18/2016 SPbSTU reports template v2]

%% ОСНОВНЫЕ ПАКЕТЫ %%

	\RequirePackage{geometry}					% Отступы
	\geometry{									% Настройка отступов
		a4paper,
		left=20mm,
		right=10mm,
		top=15mm,
		bottom=15mm,
	}
	\RequirePackage[english,russian]{babel}		% Для русского оформления
	\selectlanguage{russian}					% Язык для babel
	\RequirePackage[T2A,T1]{fontenc}			% Кодировка шрифтов
	\RequirePackage[utf8]{inputenc}				% Для поддержки кириллицы
	\RequirePackage[pdftex]{graphicx}			% Для создания pdf
	\RequirePackage{amsthm,amssymb,amsmath}		% Математические выражения
	\RequirePackage{mathtools}					% Всякие мелочи для математики
	\RequirePackage{indentfirst}				% Отступ (красная строка)
	\RequirePackage{mmap}						% Поиск и копирование в pdf
	\pdfcompresslevel=9							% pdf сжатие
	\graphicspath{{img/}}						% Папка для изображений	
	\RequirePackage[%
		labelsep=period,
		singlelinecheck=false,
		justification=centering
	]{caption}									% Для рис. и табл.	

%% ЗАГОЛОВКИ И ТЕКСТ %%

	\RequirePackage{titlesec}	% Дополнительные возможности секционирования
	\RequirePackage{titletoc}	% Дополнительные возможности содержания
	\RequirePackage{fancyhdr}	% Колонтитулы

	% Настройка titlesec
		\titleformat{\section}{\normalsize\bfseries}{\thesection}{1em}{}
		\titleformat{\subsection}{\normalsize}{\thesubsection}{1em}{}
		\titleformat{\subsubsection}{\normalsize}{\thesubsubsection}{1em}{}

	% Настройка fancyhdr
		\renewcommand{\headrulewidth}{0pt}	% Отключает полосу сверху
		\pagestyle{fancy}					% Включение пакета fancyhdr
		\lhead{}							% Пусто вверху слева
		\chead{}							% Пусто вверху по центру
		\rhead{}							% Пусто вверху справа
		\lfoot{}							% Пусто вверху слева
		\cfoot{}							% Пусто вверху по центру
		\rfoot{\thepage}					% Номер страницы внизу справа

	\RequirePackage{setspace}				% Интерлиньяж
	% \onehalfspacing						% Интерлиньяж 1.5
	% \doublespacing						% Интерлиньяж 2
	% \singlespacing						% Интерлиньяж 1

%% ЛИСТИНГИ %%

	\RequirePackage{verbatim}	% Для простых листингов
	\RequirePackage{listings}	% Листинги (куча проблем)

%% ТАБЛИЦЫ/КАРТИНКИ %%

	\RequirePackage{supertabular}	% Для длинных многостраничных таблиц
	\RequirePackage{multirow}		% Для объединения строк
	\RequirePackage{multicol}		% Несколько колонок
	\RequirePackage{tabularx}		% Окружение для использования опции x для подгона ширины столбца
	\RequirePackage{tabulary}		% Окружение для выравнивания по высоте
	\RequirePackage{longtable}		% Многостраничная таблица
	\RequirePackage{float}			% Используется для опции [H]
	\RequirePackage{wrapfig}		% Обтекание рисунков и таблиц текстом

	% Настройка chngcntr
		\numberwithin{equation}{section}	% Формулы нумеруются по секциям (amsmath)
		% \mathtoolsset{showonlyrefs=true}	% Номера только у формул, на которые есть \eqref{}
		\RequirePackage{chngcntr}			% Картинки/таблицы нумеруются по секциям
		\counterwithin{figure}{section}		% Настройка пакета chngcntr
		\counterwithin{table}{section}
		\AtBeginDocument{\counterwithin{lstlisting}{section}}
		%\counterwithin{figure}{subsection}
		%\counterwithin{table}{subsection}

	% Настройка subcaption
		\RequirePackage{subcaption}							% Несколько картинок в одной
		\renewcommand{\thesubfigure}{\asbuk{subfigure}}		% Русские буквы в подписях subcaption
		\DeclareCaptionLabelFormat{r-parens}{\textbf{#2)}}	% Стилизация subcaption
		\newcommand{\specialcell}[2][c]{\begin{tabular}[#1]{@{}c@{}}#2\end{tabular}}

		\captionsetup{font=normalsize}	% Основные настройки подписей
		\captionsetup[sub]{				% Настройки подподписей
		    font=small,					% Сделать шрифт меньше для текста и label
		%    textfont=sl,				% Сделать только текст подписи наклонным
		    labelformat=r-parens}		% Вызов этой настройки

%% ГРАФИКИ %%

	\RequirePackage{pgfplots}	% Для графиков (сложен и неудобен почти всегда)
	\pgfplotsset{compat=1.12}	% Принудительное использование данной версии

%% ОСТАЛЬНОЕ %%

	\RequirePackage{newclude}				% include*{} убирает \clearpage
	\RequirePackage{color}					% Управление цветом
	\RequirePackage[russian]{varioref}		% Умные указания страниц
	\RequirePackage[
		unicode,
		bookmarks=true,
		%allbordercolors=red,
		allbordercolors=blue,
		urlbordercolor=blue,
		pdfborderstyle={/S/U/W 1}
	]{hyperref}								% Гиперссылки
	\RequirePackage[russian]{cleveref}		% Умные указания страниц (ПОСЛЕ varioref И hyperref)
	\let\globcount\newcount					% Фикс для autonum
	\RequirePackage{autonum}				% Умная нумерация формул (ПОСЛЕ cleveref)
	\RequirePackage[numbered]{bookmark}		% Закладки
	\RequirePackage{enumerate}				% Расширенные возможности перечислений
	\RequirePackage{soulutf8}				% Для пакета soul
	\RequirePackage{soul} 					% Зачеркивания и прочие модификаторы текста
	\RequirePackage{cancel} 				% Зачеркивания (диагональные)
	\RequirePackage{ifthen}					% Условия
	% \RequirePackage{fixltx2e}				% Для \textsubscript (конфликтует с float), используйте \text(up)(it)...
	% \RequirePackage{extsizes}				% Шрифты больше 12pt (в этом шаблоне не нужен)

	% Настройки cleveref
	\crefformat{equation}{(#2#1#3)}
	\crefrangeformat{equation}{(#3#1#4) to~(#5#2#6)}
	\crefmultiformat{equation}{(#2#1#3)}{ and~(#2#1#3)}{, (#2#1#3)}{ and~(#2#1#3)}
	\crefname{appsec}{прил.}{прил.}
	\Crefname{appsec}{Приложение}{Приложения}
	% \crefname{lstlisting}{листинг}{листинги}

%% ШАБЛОН ТИТУЛЬНОГО ЛИСТА %%

	% Используйте \maketitle для вызова, при сборке без необходимых команд в преамбуле
	% они будут отображены на листе.
	% Дополнительная команда: \titleright{} для сдвига области имен

	\newcommand*{\student}[1]{\gdef\@student{#1}}
	\newcommand*{\@student}{\texttt{\string\student\{\}}}

	\newcommand*{\studentt}[1]{\gdef\@studentt{#1}}
	\newcommand*{\@studentt}{\texttt{\string\studentt\{\}}}

	\newcommand*{\group}[1]{\gdef\@group{#1}}
	\newcommand*{\@group}{\texttt{\string\group\{\}}}

	\newcommand*{\teacher}[1]{\gdef\@teacher{#1}}
	\newcommand*{\@teacher}{\texttt{\string\teacher\{\}}}

	\newcommand*{\papertype}[1]{\gdef\@papertype{#1}}
	\newcommand*{\@papertype}{\texttt{\string\papertype\{\}} (в дат. п.)}

	\newcommand*{\lessontype}[1]{\gdef\@lessontype{#1}}
	\newcommand*{\@lessontype}{\texttt{\string\lessontype\{\}}}
	
	\newcommand*{\theme}[1]{\gdef\@theme{#1}}
	\newcommand*{\@theme}{\texttt{\string\theme\{\}}}

	\newcommand*{\titleright}[1]{\gdef\@titleright{#1}}
	\newcommand*{\@titleright}{10}

	\renewcommand*{\maketitle}{%
	\begin{titlepage}
	\begin{center}
	% Шапка
	Санкт-Петербургский государственный политехнический \\ университет Петра Великого \\[0.1cm]
	Кафедра компьютерных систем и программных технологий \\[9cm]
	% Основная часть
	\textbf{Отчет по \@papertype\unskip\strut}\\[0.1cm]
	\textbf{Дисциплина:} \@lessontype\unskip\strut \\[0.1cm]
	\textbf{Тема:} \@theme\unskip\strut
	\end{center}
	\vfill
	% Имена/подписи
	\ifthenelse{\not\equal{\@studentt}{\texttt{\string\studentt\{\}}} \OR \equal{\@student}{\texttt{\string\student\{\}}}}{
			\flushleft{Выполнили студенты гр. \@group\unskip\strut} 
			\hfill\parbox{\@titleright cm}{\hspace*{3cm}\hbox to 0cm{\raisebox{-1em}{\small(подпись)}}\hspace*{-0.8cm}\rule{3cm}{0.8pt} \@student\unskip\strut}\\[0.6cm]

			\hfill\parbox{\@titleright cm}{\hspace*{3cm}\hbox to 0cm{\raisebox{-1em}{\small(подпись)}}\hspace*{-0.8cm}\rule{3cm}{0.8pt} \@studentt\unskip\strut}\\[0.6cm]
		}{
			\flushleft{Выполнил студент гр. \@group\unskip\strut} 
			\hfill\parbox{\@titleright cm}{\hspace*{3cm}\hbox to 0cm{\raisebox{-1em}{\small(подпись)}}\hspace*{-0.8cm}\rule{3cm}{0.8pt} \@student\unskip\strut}\\[0.6cm]
	}

	\flushleft{Преподаватель} \hfill\parbox{\@titleright cm}{\hspace*{3cm}\hbox to 0cm{\raisebox{-1em}{\small(подпись)}}\hspace*{-0.8cm}\rule{3cm}{0.8pt} \@teacher\unskip\strut}\\[0.6cm]

	\hfill\parbox{10cm}{\hspace*{3cm}``\rule{0.7cm}{0.8pt}''\rule{3cm}{0.8pt}~\the\year~г.}
	\vfill
	\begin{center}
	% Bottom of the page
	Санкт-Петербург \par
	\the\year~г.
	\end{center}
	\end{titlepage}
	\setcounter{page}{2}
	}

%% ПРИЛОЖЕНИЯ %%
	
	% Используйте окружение \begin{append} и \section для приложений
	% Реализовано добавление подсекции и автоперенос на следующую страницу
	% Использует пакет appendix
	% Требуется две компиляции для верного отображения

	\RequirePackage[title,titletoc]{appendix}

	\newenvironment{append}[1][Приложение]{%
		\clearpage
		\begin{appendices}
		\newcommand{\sectionbreak}{\clearpage}
		\crefalias{section}{appsec}	% Для \cref в cleveref
		\titleformat{\section}{\normalsize\bfseries}{\appendixname~\thesection}{1em}{}
		\titleformat{\subsection}{\normalsize}{\thesubsection}{1em}{}
		\renewcommand{\appendixname}{#1}
		\renewcommand{\thesection}{\Asbuk{section}}
	}{
		\end{appendices}
	}

	% Взято отсюда: http://tex.stackexchange.com/questions/41649/how-to-make-appendix-and-hyperref-packages-work-together-with-cyrillic-non-asci
	\makeatletter
	\let\oriAlph\Alph
	\let\orialph\alph
	\renewcommand{\@resets@pp}{\par
		\@ppsavesec
		\stepcounter{@pps}
		\setcounter{section}{0}%
		\if@chapter@pp
			\setcounter{chapter}{0}%
			\renewcommand\@chapapp{\appendixname}%
			\renewcommand\thechapter{\@Alph\c@chapter}%
		\else
			\setcounter{subsection}{0}%
			\renewcommand\thesection{\@Alph\c@section}%
		\fi
		\if@pphyper
			\if@chapter@pp
				\renewcommand{\theHchapter}{\theH@pps.\oriAlph{chapter}}%
			\else
				\renewcommand{\theHsection}{\theH@pps.\oriAlph{section}}%
			\fi
			\def\Hy@chapapp{appendix}%
		\fi
		\restoreapp
	}
	\makeatother

%% СПИСОК ЛИТЕРАТУРЫ %%

	% Требуется 3-4 компиляции:
	% latex (PDFlatex)
	% biber
	% latex (PDFlatex) - 1-2 раза
	
	% Используется команда \lib для создания библиографии


	% Для создания библиографической базы рекомендуется использовать JabRef
	% Создать область наиболее часто используемых полей для заполнения можно, добавив в меню
	% Options -> Set up general fields следующие строки (без %):
	% biber:title;author;year;publisher;address;language;langid;pagetotal;media;url;urldate;bibtexkey
	% biber_misc:pages;note;editor;translator;edition;version;volumes;books;parts

	\RequirePackage{csquotes}
	\RequirePackage[%
		autolang=other,							% Язык
		bibencoding=utf8,						% Кодировка
		sorting=none,							% Name,Title,Year или sorting=none.
		maxbibnames=3,							% Максимальное число авторов в списке литературы.
		minbibnames=2,							% Число авторов, отображаемое при сокращении.
		style=gost-numeric,						% Стиль
		backend=biber,							% Использование biber вмето BiBTeX
%		backref,								% Указание на место цитирования
%		backrefstyle=two						% Компрессия страниц указаний на место цитирования
	]{biblatex}									% Библиография

	\newcommand*{\lib}[1][Список литературы]{%
		\newpage
		\phantomsection
		\addcontentsline{toc}{section}{#1} 
		\printbibliography[title=#1]
	}

%% СОКРАЩЕНИЕ КОМАНДЫ ГЕНЕРАЦИИ ОГЛАВЛЕНИЯ, СПИСКОВ РИСУНКОВ И ТАБЛИЦ %%
	
	\newcommand*{\toc}[1][Содержание]{%
		\renewcommand\contentsname{#1}
		\tableofcontents
		\clearpage
	}

	\newcommand*{\lof}[1][Список иллюстраций]{%
		\renewcommand\listfigurename{#1}
		\newpage
		\phantomsection
		\addcontentsline{toc}{section}{#1}
		\listoffigures
		\clearpage
	}

	\newcommand*{\lot}[1][Список таблиц]{%
		\renewcommand\listtablename{#1}
		\newpage
		\phantomsection
		\addcontentsline{toc}{section}{#1}
		\listoftables
		\clearpage
	}

	% РАБОТАЕТ ТОЛЬКО С ПАКЕТОМ LISTINGS, VERBATIM НЕ УЧИТЫВАЕТСЯ!!!
	\newcommand*{\lol}[1][Список листингов]{%
		\renewcommand\lstlistlistingname{#1}
		\newpage
		\phantomsection
		\addcontentsline{toc}{section}{#1}
		\lstlistoflistings
		\clearpage
	}

%% НЕПРОТЕСТИРОВАННЫЕ ПАКЕТЫ И НАСТРОЙКИ %%

	\RequirePackage{icomma}						% Умная запятая ($2,4$ $2, 4$)

	\newcommand*{\hm}[1]{#1\nobreak\discretionary{}%
		{\hbox{$\mathsurround=0pt #1$}}{}}		% Дублирование знаков при переносе в формулах

	% Надо потестить пакет minted
	% Надо потестить пакет fancyvrb
	% Надо потестить пакет floatrow

\endinput